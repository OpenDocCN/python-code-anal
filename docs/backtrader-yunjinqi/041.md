# 68、backtrader 的一些高级技巧---backtrader 参数的可动态修改性与递进参数优化的实现方法

> 原文：<https://yunjinqi.blog.csdn.net/article/details/120519630>

当我们形成一个策略逻辑的时候，一般情况下，都会存在一些可以调整取值范围的变量，这些变量就是策略的参数，选择什么样的策略参数对于未来策略的表现怎么样，有一定的影响，这是因为选择不同的参数，意味着不同的开平仓点，不同的持仓时间，这往往会造成不同的参数对在过去有不同的回测结果，当然，在未来的表现，也往往并不完全相同。

选择参数，是一门艰深的科学，大家往往当成艺术，在某种程度上，可能也存在艺术的部分。正如大家通常的看法，投资是科学与艺术的结合，我更相说，投资虽然有一定的艺术性，但是更偏向于科学，之所以有很多未能解释的现象，很可能是我们认知的局限。参数的选择也一样。关于参数选择，这个话题太大，甚至一本书可能都讨论不完，这篇文章，主要分享以下 backtrader 中如何做各种参数的优化。

#### 常见的几种优化参数的方式

1.  全部数据集进行优化，选择参数

2.  数据集分成两部分，前面一部分优化参数，后面一部分测试

3.  数据集分成两部分，前面一部分测试，用后面一部分优化参数

4.  向前递进优化参数

    数据集分成固定的时间长度 x 优化参数，固定的时间 y 用于测试；x+y 不断向前滚动。这是大部分讲系统测试的书里面都会讲到的一个方法。举个例子，以螺纹钢 2010 年到 2021 年的数据为例，可以用 2010 年到 2014 年做参数优化，2015 年测试参数优化的结果；2011 年到 2015 年做参数优化，2016 年测试参数优化的结果；一直这样滚动，直到 2016 年到 2020 年做参数优化，2021 年测试参数优化的结果。

    本文主要分析这种向前递进优化参数如何实现。

显然，还有很多很多的不同的参数优化方式。也很难说，究竟哪种参数优化方式会更好。这个要根据具体的情况具体来分析。

#### 参数的动态可修改性

这个其实就是噱头，仅仅是基于 python 语法的性质。如下文中的策略，在 next 中，对参数进行赋值之后，再次调用参数的值，就发生了改变。

```py
class MaStrategy(bt.Strategy):
    # 策略作者
    author = 'yunjinqi'
    # 策略的参数
    params = (  ("ma_period",10),                  

            )
    # log 相应的信息
    def log(self, txt, dt=None):
        ''' Logging function fot this strategy'''
        dt = dt or bt.num2date(self.datas[0].datetime[0])
        print('{}, {}'.format(dt.isoformat(), txt))

    # 初始化策略的数据
    def __init__(self):
        # 基本上常用的部分属性变量
        self.bar_num = 0                 # next 运行了多少个 bar
        self.current_date = None        # 当前交易日

    def prenext(self):
        # 由于期货数据有几千个，每个期货交易日期不同，并不会自然进入 next
        # 需要在每个 prenext 中调用 next 函数进行运行
        # self.next() 
        pass 

    # 在 next 中添加相应的策略逻辑
    def next(self):
        # 每次运行一次，bar_num 自然加 1,并更新交易日
        self.bar_num+=1
        if self.bar_num%50==0:
            num=self.bar_num//50
            self.p.ma_period = num
        self.log(f"当前的均线的参数值为:{self.p.ma_period}") 
```

#### 递进优化如何实现

具体情况具体分析。

*   参数选择需要主观判断

    如果参数选择的过程需要一些主观上的判断，那么，就先对每个优化参数的时间段进行参数优化，选择出具体的参数，然后在测试阶段使用。举例说明，以上文螺纹钢 2010 年到 2021 年的数据为例，可以用 2010 年到 2014 年做参数优化，选出你认为合适的参数，然后用在 2015 年；以此类推，2016,2017,2018,2019,2020,2021 这几年都会选择一个特定的参数。

    然后在 __init__ 的时候，保存一个字典，计算每个年份的特定参数的指标值即可，这样就可以在 next 里面进行调用。

*   参数选择不需要主观判断

    其实过程本质上也是一样的，只是这个就可以在一个策略里面实现，可以不强制分成两步。

    当运行策略的时候，在测试集数据要结束的时候，即 2010-2014 年结束的时候，调用一些写好的优化参数的函数，得到优化的结果，然后决定使用那个参数应用到 2015 年；等到 2015 年要结束的时候，重新对 2011 年到 2015 年优化参数，得到参数优化的结果，用到 2016 年，以此类推。

    参数优化的函数，可以参考- 可以参考[【backtrader 的一些高级技巧】如何使用 backtrader 进行参数优化](https://yunjinqi.blog.csdn.net/article/details/120400145)

很显然，递进参数优化，需要的计算量非常大，需要电脑配置比较高。